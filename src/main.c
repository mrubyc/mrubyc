#include "mrubyc.h"
#include <stdint.h>
#include <genesis.h>

#define int8_t s8

typedef char s8;

static void c_myclass_func(mrb_vm *vm, mrb_value *v, int argc)
{
  char *ptr = mrbc_string_cstr(&v[1]);
  char buf[32];
  snprintf(buf, 31, "%s", ptr);
  VDP_drawText("Myclass.func called.", 8, 14);
  VDP_drawText(buf, 8, 16);
}

void make_class(mrb_vm *vm)
{
  mrb_class *cls = mrbc_define_class(vm, "MyClass", mrbc_class_object);
  mrbc_define_method(vm, cls, "func", c_myclass_func);
}

void mrubyc(uint8_t *mrbbuf)
{
  hal_init();
  mrbc_init_global();
  //VDP_drawText("before init class.", 10, 11);
  mrbc_init_class();
  //VDP_drawText("after init class.", 10, 14);

  mrbc_vm *vm = mrbc_vm_open(NULL);
  if( vm == 0 ) {
    return;
  }
  //VDP_drawText("after vm open.", 10, 15);

  if( mrbc_load_mrb(vm, mrbbuf) != 0 ) {
    return;
  }

  //VDP_drawText("after load mrb.", 10, 16);
  mrbc_vm_begin(vm);

  make_class(vm);
  //VDP_drawText("after make class.", 10, 17);

  mrbc_vm_run(vm);
  //VDP_drawText("after vm run.", 10, 18);
  mrbc_vm_end(vm);
  //VDP_drawText("after vm end.", 10, 19);
  mrbc_vm_close(vm);
  //VDP_drawText("after vm close.", 10, 20);
}

const uint8_t rbtest[] = {
  0x52,0x49,0x54,0x45,0x30,0x33,0x30,0x30,0x00,0x00,0x00,0x7c,0x4d,0x41,0x54,0x5a,
  0x30,0x30,0x30,0x30,0x49,0x52,0x45,0x50,0x00,0x00,0x00,0x60,0x30,0x33,0x30,0x30,
  0x00,0x00,0x00,0x54,0x00,0x01,0x00,0x04,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x0d,
  0x1d,0x01,0x00,0x51,0x02,0x00,0x2f,0x01,0x01,0x01,0x38,0x01,0x69,0x00,0x01,0x00,
  0x00,0x1e,0x48,0x65,0x6c,0x6c,0x6f,0x20,0x4d,0x65,0x67,0x61,0x64,0x72,0x69,0x76,
  0x65,0x2c,0x20,0x66,0x72,0x6f,0x6d,0x20,0x6d,0x72,0x75,0x62,0x79,0x2f,0x63,0x21,
  0x00,0x00,0x02,0x00,0x07,0x4d,0x79,0x43,0x6c,0x61,0x73,0x73,0x00,0x00,0x04,0x66,
  0x75,0x6e,0x63,0x00,0x45,0x4e,0x44,0x00,0x00,0x00,0x00,0x08,
};

/*
const uint8_t rbtest[] = {
  // "MyClass.func
  0x52,0x49,0x54,0x45,0x30,0x33,0x30,0x30,0x00,0x00,0x00,0x57,0x4d,0x41,0x54,0x5a,
  0x30,0x30,0x30,0x30,0x49,0x52,0x45,0x50,0x00,0x00,0x00,0x3b,0x30,0x33,0x30,0x30,
  0x00,0x00,0x00,0x2f,0x00,0x01,0x00,0x03,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x0a,
  0x1d,0x01,0x00,0x2f,0x01,0x01,0x00,0x38,0x01,0x69,0x00,0x00,0x00,0x02,0x00,0x07,
  0x4d,0x79,0x43,0x6c,0x61,0x73,0x73,0x00,0x00,0x04,0x66,0x75,0x6e,0x63,0x00,0x45,
  0x4e,0x44,0x00,0x00,0x00,0x00,0x08,
};
*/

int main(void) {
  // uint8_t *mrbbuf = rbtest;
  if( rbtest == 0 ) return 1;
  //VDP_drawText("before starting mrubyc!", 10, 10);

  mrubyc( rbtest );
  //free( mrbbuf );

  //VDP_drawText("Hello Megadrive World!", 1, 19);
  while(TRUE)
  {
    VDP_waitVSync();
  }
  return 0;
}
